<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Farcaster Reminder</title>
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1"
  />

  <!-- Farcaster Mini App SDK (optional: ready()) -->
  <script src="https://cdn.jsdelivr.net/npm/@farcaster/js@latest"></script>

  <style>
    :root {
      --bg-page: #fcf8ec;
      --card-bg: #fff;
      --border: #ddd;
      --radius-lg: 8px;
      --radius-sm: 4px;
      --text-main: #111;
      --text-dim: #555;
      --accent-bg: #000;
      --accent-text: #fff;
      --error-bg: #ffe5e5;
      --error-text: #a30000;
      --shadow-card: 0 20px 40px rgba(0,0,0,0.06);
    }

    body {
      background: radial-gradient(circle at 50% 0%, #fff9e9 0%, #fcf8ec 60%);
      background-color: var(--bg-page);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter",
        Roboto, "Helvetica Neue", Arial, sans-serif;
      color: var(--text-main);
      margin: 0;
      padding: 24px;
      display: flex;
      justify-content: center;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-card);
      border: 1px solid #f0ead4;
      max-width: 480px;
      width: 100%;
      padding: 24px;
    }

    .icon-row {
      text-align: center;
      font-size: 28px;
      margin-bottom: 8px;
    }

    h1 {
      text-align: center;
      font-size: 20px;
      font-weight: 600;
      margin: 0 0 20px 0;
      color: var(--text-main);
    }

    .field-block {
      margin-bottom: 16px;
    }

    .field-label-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }

    .field-label-row .main-label {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-main);
    }

    .field-label-row .hint {
      font-size: 12px;
      color: var(--text-dim);
      margin-left: 8px;
      white-space: nowrap;
    }

    textarea,
    input[type="text"],
    input[type="date"],
    input[type="time"] {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px 10px;
      font-size: 14px;
      line-height: 1.4;
      font-family: inherit;
      color: var(--text-main);
      box-sizing: border-box;
    }

    textarea {
      min-height: 90px;
      resize: vertical;
    }

    /* date+time row */
    .datetime-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .datetime-field {
      flex: 1;
      min-width: 0;
    }

    .control-row {
      text-align: center;
      margin: 20px 0;
    }

    button.save-btn {
      appearance: none;
      border: none;
      border-radius: var(--radius-sm);
      background: var(--accent-bg);
      color: var(--accent-text);
      font-size: 16px;
      font-weight: 600;
      padding: 12px 20px;
      width: 100%;
      cursor: pointer;
      box-shadow: 0 10px 20px rgba(0,0,0,0.12);
    }

    button.save-btn:active {
      opacity: 0.9;
      transform: translateY(1px);
    }

    .error-box {
      display: none;
      background: var(--error-bg);
      color: var(--error-text);
      border-radius: var(--radius-sm);
      font-size: 14px;
      line-height: 1.4;
      padding: 12px;
      margin-bottom: 20px;
      border: 1px solid #ffbaba;
      word-break: break-word;
    }

    .list-card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 16px;
      font-size: 14px;
      line-height: 1.4;
    }

    .list-header {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-main);
      margin-bottom: 12px;
    }

    .reminder-row {
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px;
      margin-bottom: 10px;
      background: #fff;
    }

    .reminder-main-line {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-main);
      margin-bottom: 4px;
      word-break: break-word;
    }

    .reminder-note {
      flex: 1;
      margin-right: 8px;
    }

    .reminder-datetime {
      white-space: nowrap;
      color: var(--text-dim);
      font-size: 13px;
      text-align: right;
    }

    .reminder-sub-line {
      font-size: 13px;
      color: var(--text-dim);
      line-height: 1.4;
      word-break: break-word;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="icon-row">ðŸ””</div>
    <h1>Farcaster Reminder</h1>

    <!-- Reminder Note -->
    <div class="field-block">
      <div class="field-label-row">
        <div class="main-label">Reminder Note</div>
        <div class="hint">ex. "Team call at 12:00"</div>
      </div>
      <textarea
        id="noteInput"
        placeholder="Write your reminder..."
      ></textarea>
    </div>

    <!-- Date / Time -->
    <div class="datetime-row">
      <div class="datetime-field">
        <div class="field-label-row">
          <div class="main-label">Date</div>
          <div class="hint">(dd.mm.yyyy)</div>
        </div>
        <input id="dateInput" type="date" />
      </div>

      <div class="datetime-field">
        <div class="field-label-row">
          <div class="main-label">Time</div>
          <div class="hint">(hh:mm)</div>
        </div>
        <input id="timeInput" type="time" />
      </div>
    </div>

    <!-- Save -->
    <div class="control-row">
      <button class="save-btn" id="saveBtn">Save</button>
    </div>

    <!-- Error box -->
    <div class="error-box" id="errorBox">
      Something went wrong while creating payment draft.
    </div>

    <!-- Saved list -->
    <div class="list-card">
      <div class="list-header">Saved Reminders</div>
      <div id="reminderList"></div>
    </div>
  </div>

  <script>
    // Mini-app ready() so the purple â€œsplash / dev warningâ€ goes away in preview
    window.onload = () => {
      if (window.sdk && window.sdk.actions && window.sdk.actions.ready) {
        window.sdk.actions.ready();
      }
    };

    // local in-memory list for UI
    const reminders = [];

    const noteInput   = document.getElementById("noteInput");
    const dateInput   = document.getElementById("dateInput");
    const timeInput   = document.getElementById("timeInput");
    const saveBtn     = document.getElementById("saveBtn");
    const errorBox    = document.getElementById("errorBox");
    const reminderDiv = document.getElementById("reminderList");

    function renderReminders() {
      // clear
      reminderDiv.innerHTML = "";

      if (reminders.length === 0) {
        // nothing saved yet
        return;
      }

      reminders.forEach((r) => {
        const row = document.createElement("div");
        row.className = "reminder-row";

        const mainLine = document.createElement("div");
        mainLine.className = "reminder-main-line";

        const noteSpan = document.createElement("div");
        noteSpan.className = "reminder-note";
        noteSpan.textContent = r.note;

        const dtSpan = document.createElement("div");
        dtSpan.className = "reminder-datetime";
        dtSpan.textContent = r.prettyDateTime;

        mainLine.appendChild(noteSpan);
        mainLine.appendChild(dtSpan);

        const subLine = document.createElement("div");
        subLine.className = "reminder-sub-line";
        subLine.textContent =
          "Payment draft: " + r.paymentSummary;

        row.appendChild(mainLine);
        row.appendChild(subLine);

        reminderDiv.appendChild(row);
      });
    }

    function showError(msg) {
      errorBox.style.display = "block";
      errorBox.textContent = msg || "Something went wrong.";
    }

    function hideError() {
      errorBox.style.display = "none";
    }

    // helper: build ISO datetime from date+time
    function buildISO(dateVal, timeVal) {
      // if date "2025-10-15" and time "18:22"
      // -> "2025-10-15T18:22:00.000Z"
      // (We treat it UTC-ish for now)
      if (!dateVal || !timeVal) return null;
      return dateVal + "T" + timeVal + ":00.000Z";
    }

    saveBtn.addEventListener("click", async () => {
      hideError();

      const noteVal = noteInput.value.trim();
      const dateVal = dateInput.value;
      const timeVal = timeInput.value;

      // basic front validation
      if (!noteVal) {
        showError("Please enter a reminder note.");
        return;
      }
      if (!dateVal || !timeVal) {
        showError("Please choose date and time.");
        return;
      }

      // build ISO
      const iso = buildISO(dateVal, timeVal);
      if (!iso) {
        showError("Invalid date/time.");
        return;
      }

      // call backend /api/pay
      let draft;
      try {
        const res = await fetch("/api/pay", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            note: noteVal,
            datetimeISO: iso,
          }),
        });

        draft = await res.json();

        if (!res.ok || !draft || !draft.ok) {
          // backend said no
          showError(
            (draft && draft.error) ||
              "Something went wrong while creating payment draft."
          );
          return;
        }
      } catch (err) {
        console.error("fetch /api/pay failed:", err);
        showError("Network / server error.");
        return;
      }

      // success -> push into reminders[]
      // user-facing datetime text
      const prettyDateTime = dateVal + " " + timeVal;
      // user-facing cost text
      const paymentSummary =
        draft.ethNeeded.toFixed(6) +
        " ETH (~$" +
        draft.usdAmount.toFixed(2) +
        ")";

      reminders.unshift({
        note: noteVal,
        iso: iso,
        prettyDateTime,
        paymentSummary,
      });

      // refresh UI
      renderReminders();

      // clear inputs for next reminder
      noteInput.value = "";
      // keep date/time? you can decide. I'll keep them for convenience:
      // dateInput.value = "";
      // timeInput.value = "";
    });

    // initial
    renderReminders();
  </script>
</body>
</html>

