<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Farcaster Reminder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Farcaster Mini Apps SDK (Preview Tool bunu gÃ¶rÃ¼nce "ready" uyarÄ±sÄ±nÄ± kaldÄ±rÄ±yor) -->
  <script src="https://cdn.jsdelivr.net/npm/@farcaster/js@latest"></script>

  <style>
    :root {
      --bg: #fffcf4;
      --card-bg: #fffdf8;
      --border: #e8e2cc;
      --text-main: #1a1a1a;
      --text-dim: #6b6555;
      --accent-bg: #fff5cc;
      --accent-border: #e2c76b;
      --accent-icon: #d4aa00;
      --error-bg: #ffe5e5;
      --error-border: #ffb3b3;
      --error-text: #a40000;
      --btn-bg: #000;
      --btn-text: #fff;
      --radius-lg: 8px;
      --radius-md: 6px;
      --radius-sm: 4px;
      --shadow-card: 0 20px 40px rgba(0,0,0,0.05);
      --shadow-focus: 0 0 0 3px rgba(0,0,0,0.08);
      --font-stack: system-ui, -apple-system, BlinkMacSystemFont, "Inter", Roboto, "Segoe UI", sans-serif;
    }

    body {
      background: var(--bg);
      color: var(--text-main);
      font-family: var(--font-stack);
      margin: 0;
      padding: 24px 16px 80px;
      display: flex;
      justify-content: center;
      line-height: 1.4;
    }

    .wrap {
      background: var(--card-bg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-card);
      border-radius: var(--radius-lg);
      max-width: 500px;
      width: 100%;
      padding: 24px 20px 32px;
    }

    header {
      text-align: center;
      margin-bottom: 16px;
    }

    .bell-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: var(--accent-bg);
      border: 1px solid var(--accent-border);
      color: var(--accent-icon);
      font-size: 20px;
      margin-bottom: 8px;
      line-height: 1;
    }

    .title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-main);
      margin: 0 0 8px 0;
    }

    .subtitle {
      font-size: 14px;
      color: var(--text-dim);
      margin: 0;
    }

    form {
      display: grid;
      grid-template-columns: 1fr;
      row-gap: 16px;
      margin-top: 16px;
    }

    .field-block {
      display: flex;
      flex-direction: column;
    }

    .field-label-row {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: 6px;
      flex-wrap: wrap;
      row-gap: 4px;
    }

    .field-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-main);
    }

    .field-hint {
      font-size: 12px;
      color: var(--text-dim);
      font-weight: 400;
    }

    textarea,
    input[type="text"],
    input[type="date"],
    input[type="time"] {
      width: 100%;
      box-sizing: border-box;
      font-family: inherit;
      font-size: 15px;
      line-height: 1.4;
      padding: 12px 12px;
      color: var(--text-main);
      background: #fff;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      box-shadow: 0 1px 2px rgba(0,0,0,0.02);
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    textarea:focus,
    input:focus {
      outline: none;
      border-color: #000;
      box-shadow: var(--shadow-focus);
      background: #fff;
    }

    .row-2col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      column-gap: 12px;
    }

    .btn-save {
      appearance: none;
      border: 0;
      background: var(--btn-bg);
      color: var(--btn-text);
      font-size: 16px;
      font-weight: 600;
      line-height: 1.2;
      padding: 14px 16px;
      border-radius: var(--radius-md);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      cursor: pointer;
      width: 100%;
    }

    .btn-save:active {
      opacity: 0.9;
    }

    .error-box {
      display: none;
      background: var(--error-bg);
      color: var(--error-text);
      border: 1px solid var(--error-border);
      font-size: 14px;
      padding: 12px;
      border-radius: var(--radius-sm);
      margin-top: 8px;
      line-height: 1.4;
      word-break: break-word;
    }

    .list-card {
      background: #fffdf8;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      margin-top: 24px;
      padding: 16px;
    }

    .list-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-main);
      margin: 0 0 12px 0;
    }

    .empty-hint {
      font-size: 14px;
      color: var(--text-dim);
      margin: 0;
    }

    .reminder-item {
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px;
      font-size: 14px;
      line-height: 1.4;
      background: #fff;
      margin-bottom: 10px;
    }

    .rem-top-row {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      row-gap: 4px;
      color: var(--text-main);
      font-weight: 500;
    }

    .rem-note {
      word-break: break-word;
      color: var(--text-main);
      font-weight: 500;
    }

    .rem-when {
      font-size: 13px;
      color: var(--text-dim);
      font-weight: 400;
    }

    .rem-draft {
      font-size: 13px;
      color: var(--text-dim);
      margin-top: 6px;
    }

    @media (max-width: 480px) {
      body {
        padding: 16px 12px 60px;
      }
      .wrap {
        padding: 20px 16px 28px;
        border-radius: var(--radius-md);
      }
      .row-2col {
        grid-template-columns: 1fr 1fr;
        column-gap: 8px;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="bell-icon">ðŸ””</div>
      <h1 class="title">Farcaster Reminder</h1>
      <p class="subtitle">
        Write a reminder and pick a date/time. Save will prepare a payment draft.
      </p>
    </header>

    <form id="reminderForm">
      <!-- Reminder Note -->
      <div class="field-block">
        <div class="field-label-row">
          <label class="field-label" for="noteInput">Reminder Note</label>
          <div class="field-hint">ex. "Team call at 12:00"</div>
        </div>
        <textarea id="noteInput" placeholder="Write your reminder..."></textarea>
      </div>

      <!-- Date / Time -->
      <div class="row-2col">
        <div class="field-block">
          <div class="field-label-row">
            <label class="field-label" for="dateInput">Date</label>
            <div class="field-hint">(dd.mm.yyyy)</div>
          </div>
          <input
            id="dateInput"
            type="date"
            style="font-family: inherit;"
          />
        </div>

        <div class="field-block">
          <div class="field-label-row">
            <label class="field-label" for="timeInput">Time</label>
            <div class="field-hint">(hh:mm)</div>
          </div>
          <input
            id="timeInput"
            type="time"
            style="font-family: inherit;"
          />
        </div>
      </div>

      <!-- Save button -->
      <button id="saveBtn" type="button" class="btn-save">Save</button>

      <!-- error box -->
      <div id="errorBox" class="error-box"></div>
    </form>

    <!-- Saved list -->
    <section class="list-card" id="savedSection">
      <h2 class="list-title">Saved Reminders</h2>
      <div id="savedList">
        <p class="empty-hint">No saved reminders yet.</p>
      </div>
    </section>
  </div>

  <script>
    // Farcaster ready() Ã§aÄŸrÄ±sÄ±: Preview Tool'daki "Ready not called" uyarÄ±sÄ±nÄ± yok eder
    window.onload = () => {
      if (window.sdk && window.sdk.actions && window.sdk.actions.ready) {
        window.sdk.actions.ready();
      }
    };

    // SABÄ°T VERÄ°LER (ÅŸimdilik hardcode)
    const FIXED_FID = 1234; // ileride gerÃ§ek Farcaster FID'i ile deÄŸiÅŸecek
    const FIXED_USD = 0.05; // her hatÄ±rlatma iÃ§in kullanÄ±cÄ±dan istenen USD tutarÄ±
    const FIXED_RECEIVER = "0xfA34687f5BdCF7DcBeBbF00e7A81c38188cf6772"; // senin adresin

    const formEl = document.getElementById("reminderForm");
    const noteEl = document.getElementById("noteInput");
    const dateEl = document.getElementById("dateInput");
    const timeEl = document.getElementById("timeInput");
    const saveBtn = document.getElementById("saveBtn");
    const errorBox = document.getElementById("errorBox");
    const savedList = document.getElementById("savedList");

    // YardÄ±mcÄ±: ISO datetime oluÅŸtur
    function buildISO(dateStr, timeStr) {
      // input[type="date"] -> "2025-10-04"
      // input[type="time"] -> "19:05"
      if (!dateStr || !timeStr) return null;
      // local --> "2025-10-04T19:05:00"
      return `${dateStr}T${timeStr}:00`;
    }

    // Reminder'Ä± DOM listesine ekle
    function appendReminderToList(reminder) {
      // reminder: { note, whenText, draftText }
      if (!reminder) return;
      // eÄŸer "No saved reminders yet." varsa temizle
      if (savedList.firstElementChild && savedList.firstElementChild.classList.contains("empty-hint")) {
        savedList.innerHTML = "";
      }

      const item = document.createElement("div");
      item.className = "reminder-item";

      const topRow = document.createElement("div");
      topRow.className = "rem-top-row";

      const noteDiv = document.createElement("div");
      noteDiv.className = "rem-note";
      noteDiv.textContent = reminder.note || "(no note)";

      const whenDiv = document.createElement("div");
      whenDiv.className = "rem-when";
      whenDiv.textContent = reminder.whenText || "";

      topRow.appendChild(noteDiv);
      topRow.appendChild(whenDiv);

      const draftDiv = document.createElement("div");
      draftDiv.className = "rem-draft";
      draftDiv.textContent = reminder.draftText || "";

      item.appendChild(topRow);
      item.appendChild(draftDiv);

      savedList.appendChild(item);
    }

    // Hata gÃ¶ster
    function showError(msg) {
      errorBox.style.display = "block";
      errorBox.textContent = msg;
    }
    function hideError() {
      errorBox.style.display = "none";
      errorBox.textContent = "";
    }

    async function handleSave() {
      hideError();

      const noteVal = noteEl.value.trim();
      const dateVal = dateEl.value; // "2025-10-04"
      const timeVal = timeEl.value; // "19:05"
      const iso = buildISO(dateVal, timeVal);

      if (!noteVal || !iso) {
        showError("Please fill note, date and time.");
        return;
      }

      // backend'in beklediÄŸi alanlarÄ± gÃ¶nderiyoruz
      const body = {
        fid: FIXED_FID,
        usdAmount: FIXED_USD,
        ethAddress: FIXED_RECEIVER,
        // bunlar backend'e extra bilgi olsun diye:
        note: noteVal,
        datetimeISO: iso
      };

      let resp;
      try {
        resp = await fetch("/api/pay", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
      } catch (err) {
        showError("Network error calling /api/pay.");
        return;
      }

      if (!resp.ok) {
        showError("Server error from /api/pay.");
        return;
      }

      let data;
      try {
        data = await resp.json();
      } catch (err) {
        showError("Could not parse server response.");
        return;
      }

      // backend (pay.js) bize ne dÃ¶ndÃ¼rÃ¼yor?
      // Orijinal pay.js taslaÄŸÄ±na gÃ¶re beklenen Ã¶rnek:
      // {
      //   ok: true,
      //   fid: 1234,
      //   usdAmount: 0.05,
      //   ethNeeded: "0.00001667",
      //   unsignedTx: {
      //      to: "...",
      //      valueEth: "...",
      //      data: "0x"
      //   },
      //   note: "This is only a draft tx..."
      // }
      if (!data || data.ok !== true) {
        const errText = data && data.error ? data.error : "Payment draft failed.";
        showError(errText);
        return;
      }

      // BaÅŸarÄ±lÄ±ysa listeye ekle
      // 1) okunabilir tarih/saat string
      const whenPretty = iso.replace("T", " ").slice(0,16); // "2025-10-04 19:05"
      // 2) payment draft text
      const draftPretty = `Payment draft: ${data.ethNeeded || "?"} ETH (~$${FIXED_USD.toFixed(2)})`;

      appendReminderToList({
        note: noteVal,
        whenText: whenPretty,
        draftText: draftPretty
      });

      // inputlarÄ± temizle
      noteEl.value = "";
      // date/time'Ä± temizlersen kullanÄ±cÄ± tekrar seÃ§mek zorunda kalÄ±r, istersen temizle:
      // dateEl.value = "";
      // timeEl.value = "";
    }

    saveBtn.addEventListener("click", handleSave);
  </script>
</body>
</html>


